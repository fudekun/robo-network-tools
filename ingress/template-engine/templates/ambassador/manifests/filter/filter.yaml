##
{{- if .Values.ambassador }}
{{- if and .Values.global.manifests (hasKey .Values.global "manifests")}}
{{- if .Values.ambassador.dynamics.k8ssso.filter }}
apiVersion: getambassador.io/v3alpha1
kind: Filter
metadata:
  name: {{ .Values.ambassador.dynamics.k8ssso.hostname }}
  labels: {{- include "common.labels.matchLabels" . | nindent 4 }}
    app.kubernetes.io/component: dependency-injection
    app.kubernetes.io/part-of: datawire.edge-stack
    app.kubernetes.io/managed-by: rdbox
    rdbox.local/format: v1beta1
    rdbox.local/chart: {{ .Chart.Version }}
spec:
  JWT:
    jwksURI: {{ .Values.ambassador.dynamics.k8ssso.filter.jwksUri }}
    injectRequestHeaders:
    - name: "Impersonate-User"
      value: {{ printf "{{ .token.Claims.preferred_username }}" | quote }}
    - name: "Impersonate-Group"
      value: {{ printf "{{range .token.Claims.groups}}{{ . }}{{end}}" | quote }}
{{- end }}
{{- end }}
{{- end }}