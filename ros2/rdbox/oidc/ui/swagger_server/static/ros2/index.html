<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="UTF-8">
  <title>ros2_oidc</title>
  </head>
  <body>
    <h1>ros2_oidc/amcl</h1>
    <ul>
      <li><a href="javascript:void(0)" onclick="call_with_token('/ros2/amcl/come_to_me', 'RDBOX_ACCESS_TOKEN')">Come To Me!!</a></li>
    </ul>
    <a href="javascript:void(0)" onclick="call_with_token('/logout', 'RDBOX_REFRESH_TOKEN')">logout</a>
    <script>
      function call_with_token(url, cookie_name) {
        try {
          var access_token = document.cookie
          .split('; ')
          .find(row => row.startsWith(cookie_name))
          .split('=')[1];
        } catch(e) {
          alert('Invalid token (TimeOut or UnAuthorized)')
          window.location.href = '/'
        }
        var xhr = new XMLHttpRequest();
        xhr.open('GET', url, true);
        xhr.setRequestHeader("Authorization", "Bearer " + access_token);
        xhr.responseType = "blob";
        xhr.onreadystatechange = function() {
            if (xhr.readyState == 4) {
                if (success) success(url, xhr.response);
            }
        };
        xhr.send(null);
      }
      function success(url, response) {
        if (url === '/logout') {
          document.cookie = "RDBOX_ACCESS_TOKEN=; expires=0";
          document.cookie = "RDBOX_REFRESH_TOKEN=; expires=0";
          window.location.href = '/'
        }
        console.log(response)
      }
    </script>
  </body>
</html>